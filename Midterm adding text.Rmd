---
title: "Midterm"
author: "Jack Chen, Emmanuel"
date: "2024-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The purpose of this project is to create a predictive model that leverages comprehensive datasets from various sources, including Philadelphia’s Open Data portal and Tigris, to enhance the accuracy of home price predictions. By focusing on local factors and features that impact property values, the team aims to deliver insights that can significantly inform Zillow's pricing strategies.

There are particular challenges associated with this exercise. First, the intricacies of the Philadelphia housing market require a nuanced understanding of various local variables, such as neighborhood characteristics, amenities, and spatial structures. Second, the analysis is limited to using Ordinary Least Squares (OLS) regression for the modeling approach, which, while foundational, may not capture complex nonlinear relationships as effectively as other algorithms. Thus, the modeling strategy involves meticulous feature selection and engineering to optimize the predictive power of the OLS regression model.

This report will detail the data gathering methods, present the summary statistics, and explore the correlations among key variables. Additionally, the findings will be visualized through various maps and scatterplots to provide a clear narrative that supports the analytical insights. By the conclusion of this project, the aim is not only to generate accurate predictions but also to foster a deeper understanding of the factors influencing housing prices in Philadelphia, ultimately guiding Zillow in enhancing its market predictions.

```{r library, include=FALSE}
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(dplyr)
library(RColorBrewer)
library(classInt)

#library(geojsonio)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 = c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")

get_breaks <- function(sf_object, column_name, num_breaks, breaktype) {
  if (!(column_name %in% colnames(sf_object))) {
    stop("The specified column does not exist in the sf object.")
  }
  column_values <- sf_object[[column_name]]
  if (!is.numeric(column_values)) {
    stop("The specified column is not numeric.")
  }
  breaks <- classInt::classIntervals(column_values, n = num_breaks, style = breaktype)$brks
  print(breaks)
}
```

# Data

The major dataset involved in this project is the Philadelphia housing price data, which serves as the dependent variable to predict. Independent variables include local amenities such as hospitals, schools, parks, and farmers' markets, all of which are crucial to understanding the factors that influence housing prices.

```{r data, include=FALSE}
studentdata = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/studentData.geo.json") %>%
   st_transform("EPSG:6565")
hospital = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/DOH_Hospitals202311.geojson") %>% 
  st_transform("EPSG:6565")
farmermarket = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Farmers_Markets.geojson") %>%
  st_transform("EPSG:6565")
parks = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Parks.geojson") %>%
  st_transform("EPSG:6565")
schools = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Schools.geojson") %>%
  st_transform("EPSG:6565")
bikestations = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/bikestation.geojson") %>%
  st_transform("EPSG:6565")
crime = read.csv("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/incidents_part1_part2.csv")
```

|              Variable              | Variable Name in Dataset |
|:----------------------------------:|:------------------------:|
|    **Internal Characteristics**    |                          |
|            Age of House            |           age            |
|       Total Number of Rooms        |         totRooms         |
|         Includes Basement?         |       incBasements       |
|           Includes A/C?            |          incAC           |
|        Quality of building         |     buildingQuality      |
|          Includes Garage?          |        incGarage         |
|        Stories in Building         |         Stories          |
|                Area                |         maxArea          |
|        Observable Sceneries        |         scenery          |
|        **Nearby Amenities**        |                          |
|       Distance to Hospitals        |                          |
| Distance to Nearest Farmers Market |                          |
|     Nearby Schools     |                          |

##Data Wrangling

In this section, the focus is on preparing and transforming the raw datasets to make them suitable for analysis. The objective is to extract relevant features, clean the data, and calculate distances to key amenities, which will serve as important predictors in the housing price prediction model.

The first step involves loading each dataset corresponding to various amenities, including farmers' markets, hospitals, parks, schools, and bike stations. For each dataset, the select() function is used to retain only the necessary variables. For instance, when selecting data for farmers' markets, the team keeps identifiers and geometric information. Similarly, the hospital dataset is filtered to retain essential hospital identifiers and geographic data, while the parks dataset selects park identifiers and their geometry for further spatial analysis.

For the schools dataset, the team filters out institutions affiliated with religious organizations, ensuring a focus on public and charter schools. This is particularly important, as it allows for a broader analysis of schools that serve a diverse population. The bike station dataset is also processed to retain necessary identifiers and spatial information, making it suitable for subsequent analyses.

```{r wrangle data, includ=FALSE}
farmersmarket.f = farmermarket %>%
  select(globalid, name, operator, zip, objectid, geometry)
hospital.f = hospital %>%
  select(OBJECTID, GEOCODING_, LONGITUDE, COUNTY, LATITUDE, ZIP_CODE, geometry)
parks.f = parks %>%
  select(OBJECTID, PARK_NAME, DPP_ASSET_ID, geometry)
schools.f = schools %>%
  filter(TYPE_SPECIFIC != "ARCHDIOCESE") %>% # Not everyone is religious, so we remove this option
  select(OBJECTID, AUN, SCHOOL_NAME, ZIP_CODE, geometry)
bikestations.f = bikestations %>%
  select(id, name, addressStreet, addressZipCode, latitude, longitude, coordinates, geometry)

studentdata.f = studentdata %>%
  dplyr::select(objectid, basements, geometry, census_tract, category_code, central_air, fireplaces, fuel, garage_type, interior_condition, location, number_of_bedrooms, number_of_bathrooms, number_stories, number_of_rooms, quality_grade, state_code, street_code, sale_price, sale_date, sale_year, total_livable_area, type_heater, total_area, unfinished, unit, view_type, year_built, zip_code, toPredict) %>%
  mutate(incBasements = case_when(
          !is.na(basements) & basements != 0~ "Y", TRUE~ "N"),
        incAC = case_when(
          central_air %in% c("1", "Y") ~ "Y",
          TRUE~ "N"),
        incGarage = case_when(
          garage_type == 0 | is.na(garage_type)  ~ "N",
          TRUE~ "Y"),
        age = 2023 - year_built,
        interiorQuality = case_when(
          interior_condition >= 2 & interior_condition <= 4 ~ "GOOD",
          interior_condition > 4 ~ "BAD",
          TRUE ~ "NA"),
        totRooms = case_when(
           is.na(number_of_bedrooms) & !is.na(number_of_bedrooms) ~ number_of_bathrooms,
           is.na(number_of_bathrooms) & !is.na(number_of_bedrooms) ~ number_of_bedrooms,
           is.na(number_of_bathrooms) & is.na(number_of_bedrooms) ~ 0,
           TRUE ~ number_of_bedrooms + number_of_bathrooms),
        stories = case_when(
           number_stories == 1  ~ "SINGLE",
           TRUE~ "MULTIPLE"),
        maxArea = case_when(
           total_livable_area > total_area ~ total_livable_area,
           TRUE ~ total_area),
        incHeater = case_when(
           type_heater == 0 | is.na(type_heater)  ~ "N",
           TRUE~ "Y"),
        scenery = case_when(
           view_type == "I" | view_type == "0" | is.na(view_type)   ~ "STANDARD",
           view_type == "A" | view_type == "B" | view_type == "C" ~ "GOOD",
           TRUE~ "BELOW AVERAGE"),
        buildingQuality = case_when(
           quality_grade %in% c("3", "4", "5", "6", "A", "A+", "A-", "B", "B+","B-","S","S+","X-")  ~ "Good",
           TRUE~ "Bad")) %>%
  dplyr::select(-basements, -central_air, -garage_type, -interior_condition, -number_stories, -type_heater, -view_type, -quality_grade) %>%
  filter(age >= 0) %>%
  filter(age < 500)


fm.idx = st_nearest_feature(studentdata.f, farmersmarket.f)
hospital.idx = st_nearest_feature(studentdata.f, hospital.f)
parks.idx = st_nearest_feature(studentdata.f, parks.f)

# Calculate distances to the nearest features using the indices
studentdata.f = studentdata.f %>%
  mutate(
    farmersmarket.d.ft = as.numeric(
      st_distance(geometry, st_geometry(farmersmarket.f)[fm.idx], by_element = TRUE)),
    hospital.d.ft = as.numeric(
      st_distance(geometry, st_geometry(hospital.f)[hospital.idx], by_element = TRUE)),
    parks.d.ft = as.numeric(
      st_distance(geometry, st_geometry(parks.f)[parks.idx], by_element = TRUE)),
    schools.c = lengths(
      st_intersects(studentdata.f, st_buffer(schools.f, units::set_units(1.5, mile)))),
    bikestations.c = lengths(
      st_intersects(studentdata.f, st_buffer(bikestations.f, units::set_units(0.5, mile))))
  )

# group_by(schools, TYPE_SPECIFIC) %>%
#   summarize(count = n()) %>%
#   arrange(-count)

modellingdata = studentdata.f %>%
  filter(toPredict == 'MODELLING') 

challengedata = studentdata.f %>%
  filter(toPredict == 'CHALLENGE')
```

##Data splitting

The process of splitting the dataset into training and testing subsets is a fundamental step in developing a predictive model. This division serves multiple purposes, primarily aimed at enhancing the model's reliability and generalizability. By segregating the data, the team ensures that the model is trained on one portion while being evaluated on a completely separate portion, which is crucial for assessing the model’s performance on unseen data.

Training the model on a subset of the data allows it to learn the underlying patterns and relationships between the input features and the target variable—in this case, housing prices. This training set is used to optimize the model’s parameters and improve its predictive capabilities. By exposing the model to a diverse range of examples during training, the team can increase the likelihood that it will perform well when applied to new, unseen data.

Additionally, setting a random seed in the data splitting process enhances reproducibility. By fixing the random seed, the team ensures that the same rows are selected for the training and testing sets each time the code is executed. This consistency is vital for validating results and conducting further analyses or iterations of the model, as it allows other researchers or analysts to replicate the findings under the same conditions.
```{r split data}
set.seed(1111) 
total_features = nrow(modellingdata)
split_index = sample(1:total_features, size = total_features * 0.6)


trainingmodel = modellingdata[split_index, ] 
testingmodel = modellingdata[-split_index, ] %>%
  select(-sale_price)
```

##Moran's I

This section of the code is dedicated to evaluating spatial autocorrelation in the housing price data using Moran's I statistic. Spatial autocorrelation measures the degree to which a variable at one location is correlated with values of the same variable at nearby locations. Understanding this spatial relationship is crucial in housing price analysis, as it can reveal patterns in property values that are influenced by geographical factors.

```{r decide moran/k, include=FALSE, eval=FALSE}
moran_results = data.frame(K = integer(),
                            Moran_I = numeric(),
                            Expectation = numeric(),
                            Variance = numeric(),
                            Standard_Deviate = numeric())
for (k in 5:20) {
  nb_k = knn2nb(knearneigh(st_coordinates(studentdata.f), k=k))
  wt_k = nb2listw(nb_k)
  moran_test = moran.test(studentdata.f$sale_price, wt_k)
  moran_I = moran_test$estimate[1]
  expectation = moran_test$estimate[2]
  variance = moran_test$estimate[3]
  standard_deviate = moran_test$statistic
  moran_results = rbind(moran_results, data.frame(K = k,
                                                   Moran_I = moran_I,
                                                   Expectation = expectation,
                                                   Variance = variance,
                                                   Standard_Deviate = standard_deviate))
}
print(moran_results)
 # K=7
```

##Correlation Matrix of Continuous Variables

The correlation matrix presented illustrates the relationships between various continuous variables related to housing prices in Philadelphia. These variables include sale price, which represents the price at which houses are sold; age, calculated as the difference between the current year and the year built; total rooms (totRooms), indicating the total number of rooms in the house, including bedrooms and bathrooms; and max area (maxArea), which compares the total livable space and total area of the house. Additionally, the matrix displays the distance to farmers markets (farmersmarket.d.ft), the distance to hospitals (hospital.d.ft), the number of schools nearby (schools.c), and the distance to bike stations (bikestations.c).

The correlation coefficients in the matrix range from -1 to 1, where positive values indicate a direct relationship between variables and negative values indicate an inverse relationship. A coefficient close to 1 implies a strong positive correlation, while a coefficient close to -1 indicates a strong negative correlation. This structure provides a clear overview of how different features relate to one another and to the sale price.
```{r data summary corrmatrix, }
corrvars = studentdata.f %>% 
  dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft) %>%
  st_drop_geometry() %>%
  select_if(is.numeric) %>% 
  na.omit()

ggcorrplot(
  round(cor(corrvars), 1), 
  p.mat = cor_pmat(corrvars),
  colors = c("#30003a", "white", "#063615"),
  type="lower",
  insig = "blank") +  
  labs(title = "Correlation Matrix - All Numerical Variables") +
  guides(fill = guide_legend(title = "Correlation")) +
  theme(plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x = element_text(angle = 25, size = 6),
        axis.text.y = element_text(size=6), 
        axis.title = element_text(size=8),
        axis.title.y = element_blank())
```
Upon examining the correlation matrix, several key relationships stand out. The correlation between sale price and max area appears to be notably positive, suggesting that larger houses tend to command higher prices. This aligns with the general expectation that more space translates to increased value, making it an important feature for predictive modeling.

In contrast, the variable age shows a negative correlation with sale price, indicating that older homes may be priced lower compared to newer constructions. This relationship could be influenced by various factors, including the condition of the property and the desirability of newer builds in the market.

Additionally, the correlation between the total number of rooms and sale price is expectedly positive. A higher number of rooms generally correlates with larger homes, which are typically more appealing to families, further driving up sale prices.

Interestingly, the distances to various amenities—such as farmers' markets, hospitals, and bike stations—do not exhibit strong correlations with sale prices. This could imply that while these factors are important in assessing neighborhood desirability, they may not directly influence pricing in the same manner as the physical attributes of the homes themselves.

```{r}
get_breaks(studentdata.f, 'sale_price', 4, 'quantile')
get_breaks(studentdata.f, 'maxArea', 4, 'quantile')
get_breaks(studentdata.f, 'age', 4, 'quantile')
get_breaks(studentdata.f, 'farmersmarket.d.ft', 4, 'quantile')
```

```{r variable summary dependent map}
philly = st_read("https://raw.githubusercontent.com/blackmad/neighborhoods/refs/heads/master/philadelphia.geojson") %>%
  st_transform('EPSG:6565')

print(q5(studentdata.f$sale_price))

ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = studentdata.f, size=0.75,aes(colour = q5(sale_price))) +
    scale_color_manual(values = c('#ffffb2', '#c2e699', '#78c679', '#31a354', '#006837'),
                    name = "Houses Sales Price",
                    na.value = 'transparent',
                    labels = c('< $137000', '$137000-$228000', '$228000-$330000', '$330000-$5990000', '$5990000 <')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Sale Price of Houses in Philadelphia") 
```

```{r Correlation scatter plots}
scattervars = studentdata.f %>% 
  dplyr::select(sale_price, age, totRooms, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft) %>%
  st_drop_geometry() %>%
  gather(key = "variable", value = "value", -sale_price)

ggplot(scattervars, aes(x = value, y = sale_price)) +
  geom_point(alpha = 0.6) +  
  facet_wrap(~variable, scales = "free_x") +  
  geom_smooth(method = "lm", se=F, colour = "#FA7800") +
  labs(
    title = "Correlation Between Sale Price and Other Variables",
    x = "Variable Value",
    y = "Sale Price"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(size = 10)  # Adjust facet label size
  )
```


```{r area of house map}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(maxArea))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Area (ft^2)",
                    na.value = 'transparent',
                    labels = c('< 1114', '1114-1422', '1422-2000', '2000-226512', '226512 <')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Area of Houses in Philadelphia") 
```

```{r age map}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(age))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Age of House (Yr)",
                    na.value = 'transparent',
                    labels = c('<73', '73-98', '98-103', '103-273', '273+')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Age of Houses in Philadelphia") 
```

```{r farmers market map}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(farmersmarket.d.ft))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Distance to Nearest Farmers Market (ft)",
                    na.value = 'transparent',
                    labels = c('78-2553', '2553-4565', '4565-7116', '7116-30530', '30530+')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Houses and Their Distance to Nearest Farmers Market in Philadelphia") 
```